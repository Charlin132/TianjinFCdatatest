<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" href="images/logo.png" type="image/png">
    
    <title>Â§©Ê¥•Ë∂≥ÁêÉÊï∞ÊçÆ‰∏≠ÂøÉ | Tianjin Football Legacy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+SC:wght@400;500;700;900&display=swap');
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", "Inter", "Noto Sans SC", sans-serif; 
            background-color: #F5F5F7; 
            color: #1D1D1F; 
            -webkit-font-smoothing: antialiased; 
        }
        
        .tabular-nums { font-variant-numeric: tabular-nums; letter-spacing: -0.01em; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .glass-nav { background-color: rgba(255, 255, 255, 0.85); backdrop-filter: saturate(180%) blur(20px); border-bottom: 1px solid rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 50; }
        .apple-card { background: #FFFFFF; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); border: 1px solid rgba(0,0,0,0.04); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03); }
        .apple-card:hover { transform: translateY(-1px); box-shadow: 0 8px 20px rgba(0,0,0,0.05); border-color: rgba(59, 130, 246, 0.3); }
        .cursor-grab { cursor: grab; }
        .cursor-grabbing { cursor: grabbing; }
        [x-cloak] { display: none !important; }
        .transform-gpu { transform: translate3d(0, 0, 0); }
        
        /* ÊàòÊúØÊùøÊ†∑Âºè */
        .pitch-container {
            background-color: #38a169;
            /* ‰øÆÂ§çÔºö‰ΩøÁî®Êõ¥Á®≥ÂÅ•ÁöÑËçâÁöÆÁ∫πÁêÜ */
            background-image: repeating-linear-gradient(90deg, transparent 0, transparent 49px, rgba(255,255,255,0.1) 50px), linear-gradient(rgba(255,255,255,0.05) 2px, transparent 2px);
            border: 2px solid #fff;
            border-radius: 8px;
            position: relative;
            width: 100%;
            height: 100%; /* Â°´Êª°Áà∂ÂÆπÂô® */
            box-shadow: inset 0 0 20px rgba(0,0,0,0.3);
        }
        .pitch-half-line { position: absolute; left: 50%; top: 0; height: 100%; width: 2px; background-color: rgba(255,255,255,0.6); transform: translateX(-50%); }
        .pitch-center-circle { position: absolute; top: 50%; left: 50%; width: 80px; height: 80px; border: 2px solid rgba(255,255,255,0.6); border-radius: 50%; transform: translate(-50%, -50%); }
        .pitch-box { position: absolute; top: 20%; left: 0; width: 15%; height: 60%; border: 2px solid rgba(255,255,255,0.6); border-left: none; }
        .player-node { position: absolute; transform: translate(-50%, -50%); display: flex; flex-direction: column; align-items: center; width: 60px; z-index: 10; transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .player-dot { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 11px; color: #1e3a8a; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.4); border: 2px solid #fff; }
        .player-dot.gk { background: #fbbf24; color: #78350f; border-color: #f59e0b; }
        .player-name-tag { background: rgba(0,0,0,0.7); color: white; padding: 1px 5px; border-radius: 3px; font-size: 9px; margin-top: 3px; white-space: nowrap; backdrop-filter: blur(2px); }
    </style>
</head>

<body x-data="footballApp()" x-init="initApp(); initInteractions()" 
      class="flex flex-col min-h-screen selection:bg-blue-100 selection:text-blue-900">

    <nav class="glass-nav flex-none sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 lg:px-12 h-16 flex items-center justify-between gap-4">
            <a href="index.html" class="flex items-center gap-3 shrink-0 group cursor-pointer" @click="handleYearClick(null)">
                <img src="images/logo.png" alt="TJ" class="w-8 h-8 rounded-lg object-contain shadow-sm group-hover:scale-105 transition-transform">
                <span class="font-semibold text-lg tracking-tight text-gray-900 hidden md:block">Â§©Ê¥•Ë∂≥ÁêÉÊï∞ÊçÆ‰∏≠ÂøÉ</span>
            </a>

            <div class="flex-1 max-w-lg relative group">
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                    </div>
                    <input type="text" x-model="searchQuery" @input="performSearch()" @click.outside="searchResults = []"
                           class="block w-full pl-9 pr-3 py-2 border-none rounded-full bg-gray-100/80 text-gray-900 text-sm placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:bg-white transition-all" 
                           placeholder="ÊêúÁ¥¢ÁêÉÂëòÊàñÊïôÁªÉ...">
                </div>
                <div x-show="searchResults.length > 0" x-transition class="absolute top-full left-0 right-0 mt-2 bg-white/90 backdrop-blur-xl rounded-2xl shadow-xl border border-gray-100 overflow-hidden z-50 max-h-80 overflow-y-auto">
                    <template x-for="res in searchResults" :key="res.id">
                        <a :href="'player.html?key=' + btoa(res.id) + '&name=' + encodeURIComponent(res.name)" 
                           class="flex items-center gap-3 px-4 py-3 hover:bg-blue-50/50 cursor-pointer transition-colors border-b border-gray-50/50 last:border-0">
                            <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-xs font-bold text-gray-500 overflow-hidden">
                                <img src="images/players/default.jpg" class="w-full h-full object-cover opacity-80">
                            </div>
                            <span class="text-sm font-bold text-gray-900" x-text="res.name"></span>
                        </a>
                    </template>
                </div>
            </div>

            <div class="flex items-center gap-2 shrink-0">
                <a href="dataindex.html" class="flex items-center gap-2 px-4 py-2 text-xs font-bold text-gray-600 hover:text-blue-600 bg-gray-100 hover:bg-blue-50 rounded-full transition-all">
                    <span>üìä</span> <span class="hidden md:inline">ÂéÜÂè≤ÁªüËÆ°</span>
                </a>
                <button x-show="currentYear !== null" @click="handleYearClick(null)" class="bg-gray-900 hover:bg-black text-white px-4 py-2 rounded-full text-xs font-bold transition-all shadow-md">
                    ËøîÂõûÈ¶ñÈ°µ
                </button>
            </div>
        </div>

        <div class="border-t border-gray-200/50 bg-white/60 backdrop-blur-md">
            <div class="max-w-7xl mx-auto">
                <div id="timeline-scroll" class="flex items-center gap-6 lg:gap-8 overflow-x-auto hide-scrollbar py-3 px-4 lg:px-12 text-center whitespace-nowrap cursor-grab active:cursor-grabbing select-none">
                    <div @click="handleYearClick(null)" class="flex-shrink-0 transition-all px-2 font-bold text-xs uppercase tracking-wider cursor-pointer" :class="currentYear === null ? 'text-blue-600 scale-105' : 'text-gray-400 hover:text-gray-600'">Overview</div>
                    <template x-for="year in years" :key="year">
                        <div @click="handleYearClick(year)" class="flex-shrink-0 transition-all duration-300 group flex flex-col items-center gap-1 w-10 lg:w-12 pt-1 cursor-pointer" :class="[currentYear === year ? 'opacity-100 scale-110' : (hasYearData(year) ? 'opacity-60 hover:opacity-100' : 'opacity-20 grayscale pointer-events-none')]">
                            <span class="font-bold tabular-nums text-sm pointer-events-none" x-text="year"></span>
                            <div class="w-1.5 h-1.5 rounded-full transition-all pointer-events-none" :class="currentYear === year ? 'bg-blue-600 w-2 h-2 shadow-lg shadow-blue-500/50' : (hasYearData(year) ? 'bg-gray-400' : 'bg-transparent')"></div>
                        </div>
                    </template>
                    <div class="w-8 flex-shrink-0"></div>
                </div>
            </div>
        </div>
    </nav>

    <main class="flex-grow max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-12 pt-8 lg:pt-12">
        
     

        <div x-show="currentYear === null" x-transition.opacity.duration.500ms>
            <header class="mb-12 lg:mb-16 text-center lg:text-left">
                <h1 class="text-4xl lg:text-7xl font-bold tracking-tight mb-4 lg:mb-6 text-gray-900 leading-tight">‰º†Êâø‰∏éËç£ËÄÄ<br><span class="text-gray-400 text-3xl lg:text-5xl block mt-2">Since 1956</span></h1>
            </header>
            <section class="mb-20">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 lg:gap-6">
                    <div class="apple-card rounded-[32px] p-6 lg:p-8 flex flex-col justify-between h-48 lg:h-56">
                        <div class="text-gray-500 font-medium text-xs lg:text-sm uppercase tracking-wide">Matches Played</div>
                        <div><span class="text-5xl lg:text-6xl font-bold tracking-tighter text-gray-900 tabular-nums" x-text="totalStats.matches"></span><span class="text-gray-400 text-lg ml-1">Âú∫</span></div>
                    </div>
                    <div class="apple-card rounded-[32px] p-6 lg:p-8 flex flex-col justify-between h-48 lg:h-56">
                        <div class="text-gray-500 font-medium text-xs lg:text-sm uppercase tracking-wide">Goals Scored</div>
                        <div><span class="text-5xl lg:text-6xl font-bold tracking-tighter text-blue-600 tabular-nums" x-text="totalStats.goals"></span><span class="text-gray-400 text-lg ml-1">ÁêÉ</span></div>
                    </div>
                    <div class="apple-card bg-black text-white rounded-[32px] p-6 lg:p-8 flex flex-col justify-between h-48 lg:h-56 relative overflow-hidden">
                        <div class="z-10 text-gray-400 font-medium text-xs lg:text-sm uppercase tracking-wide">Win Rate</div>
                        <div class="z-10"><span class="text-5xl lg:text-6xl font-bold tracking-tighter tabular-nums" x-text="totalStats.winRate + '%'"></span></div>
                        <div class="absolute -right-6 -bottom-6 w-32 h-32 border-[10px] border-blue-500 rounded-full opacity-80" style="clip-path: polygon(0 0, 100% 0, 100% 42%, 0 42%);"></div>
                    </div>
                </div>
            </section>
        </div>

        <div x-show="currentYear !== null && !isLoading" x-cloak x-transition.opacity.duration.500ms>
            <div class="mb-12 lg:mb-20 pb-8 border-b border-gray-200 flex flex-col lg:flex-row justify-between items-start gap-6">
                <div class="w-full lg:w-auto">
                    <div class="flex flex-wrap gap-2 mb-4" x-show="currentYearData.summaryInfo?.Tags">
                        <template x-for="tag in currentYearData.summaryInfo?.Tags" :key="tag">
                            <span class="px-3 py-1 bg-slate-900 text-white rounded-full text-xs font-bold tracking-wide shadow-sm" x-text="'#' + tag"></span>
                        </template>
                    </div>
                    <h1 class="text-6xl lg:text-9xl font-bold text-gray-900 tracking-tighter leading-none tabular-nums" x-text="currentYear"></h1>
                    <div class="text-lg lg:text-xl text-gray-500 mt-3 font-medium flex items-center gap-2">
                        <span>Âπ¥Â∫¶‰∏ªÂ∏Ö:</span>
                        <div @click="openProfile(currentYearData.summaryInfo?.CoachID, 'coach', {name: currentYearData.summaryInfo?.Coach})" class="group flex items-center gap-2 cursor-pointer hover:bg-white hover:shadow-sm border border-transparent hover:border-gray-100 px-2 py-1 rounded-full transition-all -ml-2">
                             <div class="w-6 h-6 rounded-full bg-gray-200 overflow-hidden flex items-center justify-center text-[10px]">üëî</div>
                            <span class="font-bold text-gray-900 group-hover:text-blue-600 transition-colors" x-text="currentYearData.summaryInfo?.Coach || '-'"></span>
                        </div>
                    </div>
                    <div class="text-sm lg:text-base text-gray-500 mt-4 max-w-2xl leading-relaxed font-medium" x-text="currentYearData.summaryInfo?.SummaryText || ''"></div>
                </div>
                <div class="flex gap-3 w-full lg:w-auto self-end lg:flex-col xl:flex-row">
                    <div class="bg-white px-6 py-4 rounded-2xl shadow-sm border border-gray-100 text-center flex-1 lg:flex-none min-w-[100px]">
                        <div class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">ÊéíÂêç</div>
                        <div class="text-2xl lg:text-3xl font-bold text-gray-900 tabular-nums" x-text="currentYearData.summaryInfo?.Rank || '-'"></div>
                    </div>
                    <div class="bg-blue-600 px-6 py-4 rounded-2xl shadow-lg shadow-blue-200 text-center flex-1 lg:flex-none text-white min-w-[100px]">
                        <div class="text-[10px] text-blue-200 uppercase font-bold tracking-wider">ÁßØÂàÜ</div>
                        <div class="text-2xl lg:text-3xl font-bold tabular-nums" x-text="currentYearData.summaryInfo?.Points || '-'"></div>
                    </div>
                </div>
            </div>

            <section class="mb-16 lg:mb-24" x-show="currentYearData.photos && currentYearData.photos.length > 0">
                <div class="flex items-center justify-between mb-6 px-1"><h3 class="text-2xl font-bold text-gray-900 tracking-tight">Á≤æÂΩ©Áû¨Èó¥</h3></div>
                <div class="flex overflow-x-auto snap-x snap-mandatory gap-4 lg:gap-6 pb-8 -mx-4 px-4 lg:-mx-12 lg:px-12 hide-scrollbar cursor-grab active:cursor-grabbing">
                    <template x-for="photo in currentYearData.photos" :key="photo.url">
                        <div class="snap-center shrink-0 relative w-[85vw] md:w-[500px] lg:w-[600px] aspect-[16/9] rounded-[24px] lg:rounded-[32px] overflow-hidden group shadow-md transition-all duration-500 hover:shadow-xl border border-gray-100/50 bg-gray-100">
                            <img :src="photo.url" loading="lazy" class="absolute inset-0 w-full h-full object-cover transition-transform duration-[800ms] group-hover:scale-105">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent opacity-90"></div>
                            <div class="absolute bottom-0 left-0 p-6 lg:p-8 w-full transform transition-transform duration-500 translate-y-2 group-hover:translate-y-0">
                                <div class="inline-block px-2 py-1 bg-white/20 backdrop-blur-md rounded-lg text-[10px] font-bold text-white uppercase tracking-widest mb-2 border border-white/10" x-text="photo.tag || 'MOMENT'"></div>
                                <h4 class="text-xl lg:text-3xl font-bold text-white mb-2 leading-tight tracking-tight" x-text="photo.title"></h4>
                            </div>
                        </div>
                    </template>
                    <div class="w-2 shrink-0"></div>
                </div>
            </section>

            <section class="mb-16 lg:mb-24" x-show="currentYearData.staff && currentYearData.staff.length > 0">
                <div class="flex items-center justify-between mb-6"><h3 class="text-2xl font-bold text-gray-900 tracking-tight">ÂπïÂêéËã±ÈõÑ</h3></div>
                <div class="flex flex-wrap gap-3 lg:gap-4">
                    <template x-for="s in currentYearData.staff" :key="s.name">
                        <div @click="openProfile(s.id || s.name, 'staff', s)" class="group relative bg-white border border-gray-200 rounded-full px-2 py-1.5 pr-5 flex items-center gap-3 shadow-sm min-w-[160px] cursor-pointer transition-all hover:shadow-md hover:border-blue-300 select-none">
                            <div class="w-9 h-9 rounded-full bg-gray-100 flex items-center justify-center text-[10px] font-bold text-gray-500 overflow-hidden shrink-0">
                                <template x-if="s.img_url"><img :src="s.img_url" class="w-full h-full object-cover"></template>
                                <template x-if="!s.img_url"><span x-text="s.role ? s.role.substring(0,2) : 'ST'"></span></template>
                            </div>
                            <div class="flex flex-col overflow-hidden"><span class="text-xs font-bold text-gray-900 truncate" x-text="s.name"></span><span class="text-[10px] text-gray-400 uppercase tracking-wide truncate" x-text="s.role"></span></div>
                        </div>
                    </template>
                </div>
            </section>

            <section class="mb-16 lg:mb-24">
                <div class="flex items-center justify-between mb-8"><h3 class="text-2xl font-bold text-gray-900 tracking-tight">ËµõÂ≠£ÈòµÂÆπ</h3></div>
                <template x-for="group in positionGroups" :key="group.code">
                    <div class="mb-10" x-show="getPlayersByPos(group.code).length > 0">
                        <div class="flex items-center gap-2 mb-4 px-1">
                            <div class="w-1.5 h-1.5 rounded-full" :class="group.dotColor"></div>
                            <h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest" x-text="group.label"></h4>
                            <div class="h-px bg-gray-100 flex-1 ml-2"></div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3 lg:gap-4">
                            <template x-for="p in getPlayersByPos(group.code)" :key="p.id">
                                <div @click="openProfile(p.id, 'player', p)" class="group relative bg-white border border-gray-100 rounded-xl p-3 h-16 lg:h-18 flex items-center justify-between cursor-pointer shadow-sm hover:shadow-md hover:border-blue-300 transition-all select-none overflow-hidden">
                                    <div class="flex items-center gap-3 w-full overflow-hidden">
                                        <div class="relative w-9 h-9 shrink-0 flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
                                            <span class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 mt-1 text-[10px] font-black tabular-nums font-mono z-10" :class="p.Position === 'GK' ? 'text-yellow-900' : 'text-blue-900'" x-text="p.Number || '-'"></span>
                                            <svg class="w-full h-full drop-shadow-sm" :class="p.Position === 'GK' ? 'text-yellow-400' : 'text-gray-100 fill-current'" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C9 2 7 3.5 6 5V8H2L3 13H6V21C6 21.6 6.4 22 7 22H17C17.6 22 18 21.6 18 21V13H21L22 8H18V5C17 3.5 15 2 12 2Z"/></svg>
                                        </div>
                                        <div class="flex flex-col overflow-hidden">
                                            <div class="font-bold text-gray-800 text-sm truncate" x-text="p.Name"></div>
                                            <span class="text-[9px] font-bold text-blue-600 bg-blue-50 px-1 rounded w-fit" x-show="p.is_foreign">INT</span>
                                        </div>
                                        <div class="ml-auto text-[10px] font-mono text-blue-600 bg-blue-50 px-1.5 py-0.5 rounded-md font-bold shrink-0" x-show="p.Goals > 0" x-text="p.Goals + 'ÁêÉ'"></div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </template>
            </section>

            <section class="w-full mb-20" x-show="currentYearData.matches && currentYearData.matches.length > 0">
                <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between mb-6 pb-2 border-b border-gray-100 gap-4">
                    <h3 class="text-2xl font-bold text-gray-900 tracking-tight flex items-center gap-4"><span>ËµõÂ≠£ÂÖ®ËÆ∞ÂΩï</span></h3>
                    <div class="flex flex-wrap gap-2">
                        <button @click="matchFilter = 'all'" class="px-3 py-1 rounded-full text-xs font-bold transition-all border" :class="matchFilter === 'all' ? 'bg-blue-600 text-white border-blue-600 shadow-md' : 'bg-white text-gray-500 border-gray-200 hover:border-blue-300'">ÂÖ®ÈÉ®</button>
                        <template x-for="type in matchTypes" :key="type">
                            <button @click="matchFilter = type" class="px-3 py-1 rounded-full text-xs font-bold transition-all border" :class="matchFilter === type ? 'bg-blue-600 text-white border-blue-600 shadow-md' : 'bg-white text-gray-500 border-gray-200 hover:border-blue-300'" x-text="type"></button>
                        </template>
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-3 lg:gap-4">
    <template x-for="(match, index) in currentYearData.matches" :key="index">
        
        <div x-show="matchFilter === 'all' || matchFilter === match.Type"
     @click="openMatchModal(match)" 
     class="cursor-pointer group relative bg-white border border-gray-100 rounded-[20px] shadow-[0_2px_8px_rgba(0,0,0,0.02)] hover:shadow-[0_12px_24px_rgba(0,0,0,0.06)] hover:border-blue-100/50 hover:-translate-y-0.5 transition-all duration-300 overflow-hidden">
    
    <div class="flex items-center gap-4 px-5 py-5 lg:px-6">
        <div class="flex flex-col items-start justify-center w-28 shrink-0 border-r border-gray-100 pr-4 mr-1">
            <div class="text-sm font-black text-gray-900 tabular-nums tracking-tight" x-text="match.Date"></div>
            
            <div class="flex flex-wrap items-center gap-1.5 mt-2">
                <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-bold bg-gray-100 text-gray-500 tabular-nums" 
      x-show="match.Round">
    <span x-text="match.Round"></span>
</span>
                <span class="text-[10px] font-bold truncate" 
                      :class="match.Type.includes('Ë∂≥ÂçèÊùØ') ? 'text-orange-500' : 'text-blue-600'" 
                      x-text="match.Type"></span>
            </div>
        </div>
        
        <div class="flex-1 grid grid-cols-[1fr_auto_1fr] items-center gap-3 lg:gap-6 min-w-0">
    <div class="flex items-center justify-end">
        <span class="truncate text-right text-[15px] lg:text-lg leading-tight transition-colors" 
              :class="match.HomeTeamId === 'T001' ? 'text-blue-800 font-black' : 'text-gray-500 font-bold'" 
              x-text="match.HomeTeam"></span>
    </div>
    
    <div class="w-16 h-8 bg-gray-50 rounded-lg flex items-center justify-center shrink-0 border border-gray-200 group-hover:bg-white group-hover:shadow-inner transition-all relative">
            <div x-show="match.PKScore" class="absolute -top-2 bg-blue-600 text-white text-[8px] px-1 rounded-full font-bold shadow-sm z-10">ÁÇπÁêÉ</div>
        <span class="font-mono font-black text-lg tracking-widest text-gray-900" x-text="match.DisplayScore"></span>
    </div>
    
    <div class="flex items-center justify-start">
        <span class="truncate text-left text-[15px] lg:text-lg leading-tight transition-colors" 
              :class="match.AwayTeamId === 'T001' ? 'text-blue-800 font-black' : 'text-gray-500 font-bold'" 
              x-text="match.AwayTeam"></span>
    </div>
</div>

        <div class="w-10 flex justify-end shrink-0 pl-2">
            <div class="w-8 h-8 rounded-full flex items-center justify-center text-[10px] font-black text-white shadow-sm ring-2 ring-gray-50 group-hover:ring-blue-50 transition-all" 
                 :class="{'bg-emerald-500': match.Result === 'W', 'bg-slate-400': match.Result === 'D', 'bg-rose-500': match.Result === 'L'}" 
                 x-text="match.Result">
            </div>
        </div>
    </div>
</div>
            </div>
        </div>
    </template>
</div>
            </section>
        </div>
    </main>

    <footer class="flex-none w-full py-8 mt-12 border-t border-gray-200 bg-white">
        <div class="flex justify-center items-center"><span class="text-xs font-medium text-gray-400 tracking-wide font-[Inter]">Copyright ¬© Â§©Ê¥•Ë∂≥ÁêÉÂ§ßÊï∞ÊçÆÁ≤æÁ•ûÁóÖÈô¢</span></div>
    </footer>

    <div x-show="selectedMatch" x-cloak 
         class="fixed inset-0 z-[100] flex items-center justify-center p-4 lg:p-8">
        
        <div x-show="selectedMatch" x-transition.opacity class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm" @click="selectedMatch = null"></div>
        
        <div x-show="selectedMatch" 
             x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100" 
             class="bg-white rounded-[24px] shadow-2xl relative z-10 flex flex-col overflow-hidden w-[90vw] h-[85vh] lg:w-[75vw] lg:h-[75vh]">
            
            <button @click="selectedMatch = null" class="absolute top-4 right-4 z-50 bg-white/80 hover:bg-white text-gray-800 p-2 rounded-full shadow-sm backdrop-blur transition-all">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
    
            <div class="bg-white border-b border-gray-100 shrink-0 shadow-sm z-20 relative overflow-hidden flex flex-col">
                <div class="absolute top-0 right-0 p-4 opacity-5 pointer-events-none grayscale">
                    <img src="images/logo.png" class="w-32 h-32">
                </div>
    
                <div class="px-6 py-5 lg:px-8 relative">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2 text-xs font-bold text-gray-400 uppercase tracking-wider flex-wrap">
                            <span class="bg-gray-100 text-gray-500 px-2 py-0.5 rounded" x-text="selectedMatch?.Date"></span>
                            <span class="w-px h-3 bg-gray-300"></span>
                            <span x-text="selectedMatch?.Stadium"></span>
                            <span class="w-px h-3 bg-gray-300" x-show="selectedMatch?.Round"></span>
                            <span x-text="selectedMatch?.Round" x-show="selectedMatch?.Round"></span>
                        </div>
                    </div>
    
                    <div class="flex items-end justify-between">
                        <div class="flex items-baseline gap-4 lg:gap-8 w-full justify-center lg:justify-start">
                            <div class="flex flex-col items-end lg:items-start flex-1 lg:flex-none">
                                <span class="text-2xl lg:text-4xl font-black text-gray-900 leading-none tracking-tight text-right lg:text-left" x-text="selectedMatch?.HomeTeam"></span>
                            </div>
                            
                            <div class="flex items-center gap-3 bg-gray-900 text-white px-5 py-2 rounded-xl shadow-xl transform -skew-x-6 shrink-0">
                                <div class="transform skew-x-6 flex items-center gap-3">
                                    <span class="text-3xl font-mono font-bold tracking-widest" x-text="selectedMatch?.DisplayScore"></span>
                                    <span x-show="selectedMatch?.PKScore" class="text-[10px] bg-blue-600 px-1.5 py-0.5 rounded font-bold">ÁÇπÁêÉ</span>
                                </div>
                            </div>
    
                            <div class="flex flex-col items-start flex-1 lg:flex-none">
                                <span class="text-2xl lg:text-4xl font-black text-gray-900 leading-none tracking-tight" x-text="selectedMatch?.AwayTeam"></span>
                            </div>
                        </div>
                    </div>
                </div>
    
                <div class="px-6 py-3 bg-gray-50/50 border-t border-gray-100 flex flex-wrap items-center justify-between gap-4">
                    <div class="flex flex-wrap items-center gap-3" x-show="selectedMatch?.Referees && selectedMatch.Referees.length > 0">
                        <div class="text-[10px] font-black text-gray-300 uppercase tracking-widest mr-1">Ë£ÅÂà§ÁªÑ</div>
                        <template x-for="ref in selectedMatch.Referees" :key="ref.name">
                            <div class="flex items-center gap-2 px-2.5 py-1 rounded-full border border-gray-200 bg-white shadow-sm cursor-default">
                                <div class="flex items-center gap-1.5">
                                    <div class="w-1.5 h-1.5 rounded-full" 
                                         :class="{'bg-red-500': ref.role === 'main', 'bg-yellow-500': ref.role.includes('assistant'), 'bg-blue-400': ref.role.includes('fourth')}"></div>
                                    <span class="text-[9px] font-bold text-gray-400" x-text="ref.role_display"></span>
                                </div>
                                <span class="text-xs font-bold text-gray-700" x-text="ref.name"></span>
                            </div>
                        </template>
                    </div>
    
                    <div class="flex items-center gap-2 ml-auto" x-show="selectedMatch?.attendance && selectedMatch.attendance !== '-'">
                        <div class="text-[10px] font-black text-gray-300 uppercase tracking-widest">Áé∞Âú∫ËßÇ‰ºó</div>
                        <div class="flex items-baseline gap-1 bg-white px-3 py-1 rounded-full border border-gray-100 shadow-sm">
                            <span class="text-sm font-black text-gray-900 tabular-nums" x-text="selectedMatch?.attendance"></span>
                            <span class="text-[10px] font-bold text-gray-400">‰∫∫</span>
                        </div>
                    </div>
                </div>
            </div>
    
            <div class="flex flex-1 overflow-hidden">
                <div class="w-2/5 bg-[#38a169] relative flex items-center justify-center p-4 border-r border-gray-100 shadow-inner">
                    <div class="absolute inset-0 opacity-20" style="background-image: repeating-linear-gradient(90deg, transparent 0, transparent 49px, rgba(255,255,255,0.1) 50px), linear-gradient(rgba(255,255,255,0.05) 2px, transparent 2px); background-size: 50px 50px;"></div>
                    
                    <div class="relative w-full max-w-sm aspect-[2/3] border-2 border-white/70 rounded shadow-2xl bg-white/5 backdrop-blur-[1px] overflow-hidden">
                        <div class="absolute top-0 left-1/4 right-1/4 h-16 border-b-2 border-x-2 border-white/70"></div> 
                        <div class="absolute bottom-0 left-1/4 right-1/4 h-16 border-t-2 border-x-2 border-white/70"></div> 
                        <div class="absolute top-1/2 left-0 right-0 h-0.5 bg-white/50 transform -translate-y-1/2"></div> 
                        <div class="absolute top-1/2 left-1/2 w-20 h-20 border-2 border-white/50 rounded-full transform -translate-x-1/2 -translate-y-1/2"></div> 
                        
                        <template x-for="p in selectedMatch?.visualizedStarters" :key="p.player_id">
                            <div class="absolute transform -translate-x-1/2 -translate-y-1/2 group cursor-pointer z-10 flex flex-col items-center" 
                                    :style="p.visualizeStyle"
                                    @click.stop="openProfile(p.player_id, 'player', p)">
                                <div class="w-10 h-10 rounded-full border-[3px] shadow-lg flex items-center justify-center text-xs font-black transition-transform group-hover:scale-110 relative"
                                        :class="p.Position === 'GK' ? 'bg-yellow-400 border-yellow-200 text-yellow-900' : 'bg-white border-gray-200 text-blue-900'">
                                    <span x-text="p.number"></span>
                                </div>
                                <div class="mt-1 bg-black/50 text-white text-[9px] px-1.5 py-0.5 rounded backdrop-blur-[2px] font-medium shadow-sm whitespace-nowrap">
                                    <span x-text="p.Name"></span>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
    
                <div class="w-3/5 bg-gray-50 flex flex-col overflow-hidden">
                    <div class="flex-1 overflow-y-auto p-6 space-y-6">
                        <div x-show="selectedMatch?.goal_scorers?.length > 0">
                            <h4 class="text-xs font-black text-gray-400 uppercase tracking-widest mb-4 text-center">Á≤æÂΩ©Áû¨Èó¥</h4>
                            <div class="space-y-3 relative">
                                <div class="absolute left-1/2 top-0 bottom-0 w-px bg-gray-200 transform -translate-x-1/2 z-0"></div>
                                <template x-for="goal in selectedMatch?.goal_scorers" :key="Math.random()">
                                    <div class="flex items-center relative z-10 w-full" :class="goal.side === 'home' ? 'justify-start' : 'justify-end'">
                                        <div class="w-[45%] flex items-center gap-3 p-2 rounded-lg bg-white border border-gray-100 shadow-sm"
                                                :class="goal.side === 'home' ? 'flex-row' : 'flex-row-reverse'">
                                            <div class="font-mono font-black text-blue-600 text-sm" x-text="goal.time + '\''"></div>
                                            <div class="flex flex-col min-w-0" :class="goal.side === 'home' ? 'items-start' : 'items-end'">
                                                <span class="font-bold text-gray-900 text-sm truncate" x-text="resolveName(goal.player_id, goal.player_name, playerMap)"></span>
                                                <span class="text-[10px] bg-green-100 text-green-700 px-1.5 py-0.5 rounded font-bold" x-text="goal.is_own_goal ? '‰πåÈæô' : (goal.is_penalty ? 'ÁÇπÁêÉ' : 'ËøõÁêÉ')"></span>
                                            </div>
                                        </div>
                                        <div class="absolute left-1/2 transform -translate-x-1/2 w-2 h-2 rounded-full bg-gray-300 border-2 border-white shadow-sm"></div>
                                    </div>
                                </template>
                            </div>
                        </div>
    
                        <div>
                            <h4 class="text-xs font-black text-gray-400 uppercase tracking-widest mb-3 px-1">È¶ñÂèëÂêçÂçï / Starting XI</h4>
                            <div class="bg-white rounded-xl border border-gray-100 shadow-sm overflow-hidden divide-y divide-gray-50">
                                <template x-for="p in selectedMatch?.visualizedStarters" :key="p.player_id">
                                    <div class="flex items-center justify-between px-4 py-3 hover:bg-blue-50/50 transition-colors cursor-pointer group" 
                                            @click.stop="openProfile(p.player_id, 'player', p)">
                                        <div class="flex items-center gap-4">
                                            <div class="relative w-8 h-8 flex items-center justify-center">
                                                <svg class="w-full h-full drop-shadow-sm transition-transform group-hover:scale-110" 
                                                        :class="p.Position === 'GK' ? 'text-yellow-400' : 'text-blue-600'" 
                                                        viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M12 2C9 2 7 3.5 6 5V8H2L3 13H6V21C6 21.6 6.4 22 7 22H17C17.6 22 18 21.6 18 21V13H21L22 8H18V5C17 3.5 15 2 12 2Z"/>
                                                </svg>
                                                <span class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 mt-1 text-[10px] font-black font-mono text-white/90" x-text="p.number"></span>
                                            </div>
                                            <div class="flex flex-col">
                                                <span class="text-sm font-bold text-gray-900 group-hover:text-blue-700" x-text="p.Name"></span>
                                                <span class="text-[10px] text-gray-400" x-text="p.Position"></span>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
    
                        <div x-show="selectedMatch?.players_on_field.some(x => !x.is_starter)">
                            <h4 class="text-xs font-black text-gray-400 uppercase tracking-widest mb-3 mt-2 px-1">ÊõøË°• / Substitutes</h4>
                            <div class="grid grid-cols-1 gap-2">
                                <template x-for="p in selectedMatch?.players_on_field.filter(x => !x.is_starter)" :key="p.player_id">
                                    <div @click.stop="openProfile(p.player_id, 'player', p)" class="flex items-center justify-between p-2 rounded-lg bg-white border border-gray-100 hover:border-blue-200 cursor-pointer transition-all group">
                                        <div class="flex items-center gap-3">
                                            <div class="relative w-6 h-6 flex items-center justify-center opacity-60 group-hover:opacity-100">
                                                <svg class="w-full h-full text-gray-400" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C9 2 7 3.5 6 5V8H2L3 13H6V21C6 21.6 6.4 22 7 22H17C17.6 22 18 21.6 18 21V13H21L22 8H18V5C17 3.5 15 2 12 2Z"/></svg>
                                                <span class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 mt-0.5 text-[8px] font-black font-mono text-white" x-text="p.number"></span>
                                            </div>
                                            <span class="text-sm font-medium text-gray-600 group-hover:text-black" x-text="resolveName(p.player_id, p.player_name, playerMap)"></span>
                                        </div>
                                        <div x-show="p.sub_in_time" class="text-[10px] text-green-600 bg-green-50 px-2 py-0.5 rounded font-mono font-bold">‚Üë <span x-text="p.sub_in_time"></span>'</div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
   <div x-show="selectedProfile" x-cloak class="fixed inset-0 z-[200] flex items-center justify-center px-4 transform-gpu">
     <div x-show="selectedProfile" x-transition.opacity class="fixed inset-0 bg-gray-900/60 backdrop-blur-md" @click="selectedProfile = null"></div>
     
     <div x-show="selectedProfile" 
          x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-8 scale-95" x-transition:enter-end="opacity-100 translate-y-0 scale-100" 
          class="bg-white rounded-[32px] shadow-2xl w-full max-w-md relative z-10 overflow-hidden flex flex-col transform-gpu min-h-[400px]">
         
         <button @click="selectedProfile = null" class="absolute top-4 right-4 z-20 w-8 h-8 bg-black/5 hover:bg-black/10 rounded-full flex items-center justify-center text-gray-500 transition-colors">‚úï</button>
         
         <div class="pt-10 pb-6 px-6 flex flex-col items-center bg-gradient-to-b from-blue-50/50 to-white">
             <div class="relative mb-4 group">
                 <div class="w-24 h-24 rounded-full p-1 bg-white border border-gray-100 shadow-md">
                     <img :src="selectedProfile?.Headshot || 'images/players/default.jpg'" class="w-full h-full rounded-full object-cover">
                 </div>
                 <div class="absolute -bottom-1 -right-1 w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center text-xs font-bold border-2 border-white shadow-sm" x-text="selectedProfile?.Number"></div>
             </div>
             <h2 class="text-2xl font-bold text-gray-900 mb-1" x-text="selectedProfile?.Name"></h2>
             <span class="px-2 py-0.5 bg-gray-100 text-gray-500 rounded text-[10px] font-bold uppercase tracking-wider" x-text="selectedProfile?.Position"></span>
         </div>
         
         <div class="px-6 pb-6" x-show="selectedProfile?.type === 'player'">
             <div class="bg-slate-50 rounded-2xl p-4 border border-gray-100">
                 <div class="flex items-center justify-between mb-4">
                     <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest flex items-center gap-1">
                         <span x-text="currentYear"></span> ËµõÂ≠£Ë°®Áé∞
                     </h3>
                 </div>
                 
                 <div class="grid grid-cols-3 gap-2 text-center">
                     <div class="bg-white rounded-xl p-3 shadow-sm border border-gray-100/50">
                         <div class="text-2xl font-black text-gray-900 tabular-nums" x-text="selectedProfile?.YearStats?.Apps"></div>
                         <div class="text-[10px] text-gray-400 mt-1">Âá∫Âú∫</div>
                     </div>
                     
                     <div class="bg-white rounded-xl p-3 shadow-sm border border-gray-100/50">
                         <template x-if="selectedProfile?.Position === 'GK'">
                             <div>
                                 <div class="text-2xl font-black text-gray-900 tabular-nums" x-text="selectedProfile?.YearStats?.CleanSheets"></div>
                                 <div class="text-[10px] text-gray-400 mt-1">Èõ∂Â∞Å</div>
                             </div>
                         </template>
                         <template x-if="selectedProfile?.Position !== 'GK'">
                             <div>
                                 <div class="text-2xl font-black text-blue-600 tabular-nums" x-text="selectedProfile?.YearStats?.Goals"></div>
                                 <div class="text-[10px] text-gray-400 mt-1">ËøõÁêÉ</div>
                             </div>
                         </template>
                     </div>
                     
                     <div class="bg-white rounded-xl p-3 shadow-sm border border-gray-100/50">
                         <template x-if="selectedProfile?.Position === 'GK'">
                             <div>
                                 <div class="text-2xl font-black text-red-500 tabular-nums" x-text="selectedProfile?.YearStats?.AvgConceded"></div>
                                 <div class="text-[10px] text-gray-400 mt-1">Âú∫Âùá‰∏¢ÁêÉ</div>
                             </div>
                         </template>
                         <template x-if="selectedProfile?.Position !== 'GK'">
                             <div>
                                 <div class="text-2xl font-black text-gray-900 tabular-nums" x-text="selectedProfile?.YearStats?.AvgGoals"></div>
                                 <div class="text-[10px] text-gray-400 mt-1">Âú∫ÂùáËøõÁêÉ</div>
                             </div>
                         </template>
                     </div>
                 </div>
             </div>
         </div>
         
         <div class="p-6 pt-0 mt-auto">
             <a :href="'player.html?key=' + btoa(selectedProfile?.id) + '&name=' + encodeURIComponent(selectedProfile?.Name)" 
                class="block w-full bg-black text-white text-center py-3.5 rounded-xl font-bold text-sm hover:bg-gray-800 transition-transform active:scale-95 shadow-lg shadow-gray-200">
                 Êü•ÁúãÂÆåÊï¥ÁîüÊ∂ØÊ°£Ê°à ‚Üí
             </a>
         </div>

     </div>
</div>
    
    <script>
    function footballApp() {
        return {
            // === Âü∫Á°ÄÁä∂ÊÄÅ ===
            currentYear: null,
            isLoading: false,
            matchFilter: 'all',
            matchTypes: [],
            selectedProfile: null,
            selectedMatch: null,
            currentYearRosterMap: {},
            years: Array.from({length: 2025 - 1994 + 1}, (_, i) => 2025 - i),
            
            // === Êï∞ÊçÆÁºìÂ≠ò ===
            searchQuery: '',
            searchResults: [],
            playerMap: {},
            coachMap: {},
            stadiumMap: {},
            currentYearData: { matches: [], summaryInfo: {}, squad: [], staff: [], photos: [], insights: {} },
            totalStats: { matches: 0, goals: 0, winRate: 0 },
            
            positionGroups: [
                { code: 'GK', label: 'Èó®Â∞Ü / Goalkeepers', dotColor: 'bg-yellow-400' },
                { code: 'DF', label: 'ÂêéÂç´ / Defenders', dotColor: 'bg-blue-400' },
                { code: 'MF', label: '‰∏≠Âú∫ / Midfielders', dotColor: 'bg-green-400' },
                { code: 'FW', label: 'ÂâçÈîã / Forwards', dotColor: 'bg-red-400' }
            ],
    
            // === ÂàùÂßãÂåñ ===
            async initApp() {
                try {
                    const results = await Promise.allSettled([
                        fetch('data/player_data.json'),
                        fetch('data/coach_data.json'),
                        fetch('data/stadium_data.json'),
                        fetch('data/season.json')
                    ]);
    
                    if (results[0].status === 'fulfilled' && results[0].value.ok) {
                        const pData = await results[0].value.json();
                        (Array.isArray(pData) ? pData : pData.data).forEach(p => this.playerMap[p.id || p.Player_ID] = p.name || p.Chinese_Name);
                    }
                    if (results[1].status === 'fulfilled' && results[1].value.ok) {
                        const cData = await results[1].value.json();
                        (Array.isArray(cData) ? cData : cData.data).forEach(c => this.coachMap[c.id] = c.name);
                    }
                    if (results[2].status === 'fulfilled' && results[2].value.ok) {
                        const sData = await results[2].value.json();
                        (Array.isArray(sData) ? sData : sData.data).forEach(s => this.stadiumMap[s.id] = s.name);
                    }
                    if (results[3].status === 'fulfilled' && results[3].value.ok) {
                        const s = await results[3].value.json();
                        this.totalStats = { matches: s.totalMatches || 0, goals: s.totalGoals || 0, winRate: s.winRate || 0 };
                    }
    
                    const urlParams = new URLSearchParams(window.location.search);
                    const targetYear = urlParams.get('year');
                    if (targetYear) {
                        const yearNum = parseInt(targetYear);
                        if (!isNaN(yearNum) && this.years.includes(yearNum)) {
                            setTimeout(() => this.handleYearClick(yearNum), 500);
                        }
                    }
                } catch (e) { console.error("Init Error:", e); }
            },
    
            initInteractions() {
                const slider = document.getElementById('timeline-scroll');
                if (!slider) return;
                let isDown = false, startX, scrollLeft;
                slider.addEventListener('mousedown', (e) => { isDown = true; slider.classList.add('cursor-grabbing'); startX = e.pageX - slider.offsetLeft; scrollLeft = slider.scrollLeft; });
                slider.addEventListener('mouseleave', () => { isDown = false; slider.classList.remove('cursor-grabbing'); });
                slider.addEventListener('mouseup', () => { isDown = false; slider.classList.remove('cursor-grabbing'); });
                slider.addEventListener('mousemove', (e) => { if (!isDown) return; e.preventDefault(); const x = e.pageX - slider.offsetLeft; const walk = (x - startX) * 2; slider.scrollLeft = scrollLeft - walk; });
            },
    
            async handleYearClick(year) {
                this.currentYear = year;
                window.scrollTo({ top: 0, behavior: 'smooth' });
                if (year === null) return; 
    
                this.isLoading = true;
                this.currentYearData = { matches: [], summaryInfo: {}, squad: [], staff: [], photos: [], insights: {} };
                
                try {
                    const [resSum, resMatch] = await Promise.all([
                        fetch(`data/years/${year}_summary.json`).then(r => r.ok ? r.json() : {}), 
                        fetch(`data/years/${year}_match_data.json`).then(r => r.ok ? r.json() : [])
                    ]);
                    this.processYearData(resSum, resMatch);
                } catch (e) { console.error("Data Load Error:", e); } finally { this.isLoading = false; }
            },
    
            processYearData(summary, matches) {
                const coachObj = summary.coach || {};
                
                this.currentYearRosterMap = {};
            let squadArray = [];
            
            // 1. ÂàùÂßãÂåñÈòµÂÆπÂàóË°® (Â¢ûÂä†‰∫Ü Conceded Âíå CleanSheets Â≠óÊÆµÂàùÂßãÂåñ)
            if (summary.team_roster) {
                summary.team_roster.forEach(p => {
                    const pid = p.player_id || p.id;
                    const pname = p.player_name || p.name || this.playerMap[pid] || 'Unknown';
                    
                    this.currentYearRosterMap[pid] = { 
                        Number: p.number || '-', 
                        Position: p.position || 'MF', 
                        Name: pname 
                    };
                    
                    squadArray.push({ 
                        id: pid, ...p, Name: pname, 
                        Number: p.number || '-', Position: p.position || 'MF',
                        // üî• Ê†∏ÂøÉ‰øÆÂ§çÔºöÂàùÂßãÂåñÁªüËÆ°Êï∞ÊçÆ
                        Apps: 0, 
                        Goals: 0, 
                        CleanSheets: 0, // Èó®Â∞ÜÈõ∂Â∞Å
                        Conceded: 0     // Èó®Â∞Ü‰∏¢ÁêÉ
                    });
                });
            }

            let cleanSheets = 0; 
            const uniqueTypes = new Set(); 

            // 2. ÈÅçÂéÜÊØîËµõÔºåËøõË°åÂä®ÊÄÅËÆ°ÁÆó
            const formattedMatches = (matches || []).map(m => {
                const isTeamA_Home = m.home_away === '‰∏ª' || m.home_away === 'H';
                const isTianjinTeamA = (m.team_a?.id === 'T001') || (m.team_a?.name && m.team_a.name.includes('Â§©Ê¥•'));
                const isTianjinHome = isTianjinTeamA ? isTeamA_Home : !isTeamA_Home;
                
                uniqueTypes.add(m.league_level || m.Type || 'ÊØîËµõ');
                
                // Êú¨Âú∫ÊØîËµõÂØπÊâãÁöÑËøõÁêÉÊï∞ (Âç≥ÊàëÊñπ‰∏¢ÁêÉÊï∞)
                const opponentScore = isTianjinHome ? m.team_b_score : m.team_a_score;

                // ÁªüËÆ°ÂÖ®ÈòüÈõ∂Â∞Å
                if (opponentScore === 0) cleanSheets++;
                
                // üî• Ê†∏ÂøÉ‰øÆÂ§çÔºöÁªüËÆ°ÁêÉÂëò‰∏™‰∫∫Êï∞ÊçÆ
                if (m.players_on_field) {
                    m.players_on_field.forEach(p => { 
                        // ÊâæÂà∞ÈòµÂÆπÈáåÁöÑËøô‰∏™‰∫∫
                        const t = squadArray.find(s => String(s.id) === String(p.player_id)); 
                        if(t) {
                            t.Apps++; // Â¢ûÂä†Âá∫Âú∫Êï∞
                            
                            // Â¶ÇÊûúÊòØÈó®Â∞ÜÔºå‰∏îÊú¨Âú∫Âá∫Áé∞Âú®Âú∫‰∏ä (ËøôÈáåÁÆÄÂåñÂ§ÑÁêÜÔºåÂÅáËÆæÈó®Â∞Ü‰∏ä‰∫ÜÂ∞±ÊòØ‰∏ªÂäõÈó®Â∞Ü)
                            // Êõ¥‰∏•Ë∞®ÁöÑÈÄªËæëÊòØÂà§Êñ≠ is_starter ÊàñËÄÖÊòØ GK ‰ΩçÁΩÆ
                            if (t.Position === 'GK') {
                                t.Conceded += opponentScore; // Á¥ØÂä†‰∏¢ÁêÉ
                                if (opponentScore === 0) {
                                    t.CleanSheets++; // Á¥ØÂä†‰∏™‰∫∫Èõ∂Â∞Å
                                }
                            }
                        }
                    });
                }
                
                // ÁªüËÆ°ËøõÁêÉ
                if (m.goal_scorers) {
                    m.goal_scorers.forEach(g => {
                        const t = squadArray.find(s => String(s.id) === String(g.player_id)); 
                        // Âè™ÊúâÈùû‰πåÈæôÁêÉÊâçÁÆó‰∏™‰∫∫ËøõÁêÉ
                        if(t && !g.is_own_goal) t.Goals++;
                    });
                }

                // ... (‰∏ãÂçäÈÉ®ÂàÜ‰øùÊåÅ‰∏çÂèòÔºöIDÂ§ÑÁêÜ„ÄÅScoreÂ§ÑÁêÜ„ÄÅRoundÂ§ÑÁêÜÁ≠â) ...
                const teamAId = m.team_a?.id || null;
                const teamBId = m.team_b?.id || null;

                let processedGoals = (m.goal_scorers || []).map(g => {
                    const isGoalByTeamA = g.team === 'team_a';
                    const isHomeGoal = (isGoalByTeamA && isTeamA_Home) || (!isGoalByTeamA && !isTeamA_Home);
                    return { ...g, side: isHomeGoal ? 'home' : 'away' };
                });

                return { 
                    ...m, 
                    Date: m.date, 
                    Round: m.round || '', 
                    HomeTeam: isTeamA_Home ? (m.team_a?.name || m.team_a) : (m.team_b?.name || m.team_b),
                    AwayTeam: isTeamA_Home ? (m.team_b?.name || m.team_b) : (m.team_a?.name || m.team_a),
                    HomeTeamId: isTeamA_Home ? teamAId : teamBId,
                    AwayTeamId: isTeamA_Home ? teamBId : teamAId,
                    HomeScore: isTeamA_Home ? m.team_a_score : m.team_b_score,
                    AwayScore: isTeamA_Home ? m.team_b_score : m.team_a_score,
                    DisplayScore: isTeamA_Home ? `${m.team_a_score} - ${m.team_b_score}` : `${m.team_b_score} - ${m.team_a_score}`,
                    Result: this.normalizeResult(m.result),
                    Type: m.league_level || 'ÊØîËµõ', 
                    isTianjinHome, 
                    Stadium: m.stadium ? (typeof m.stadium === 'object' ? m.stadium.name : m.stadium) : 'Êú™Áü•ÁêÉÂú∫',
                    Referees: m.referees || [],
                    attendance: (m.attendance !== null && m.attendance !== undefined) ? m.attendance : '-',
                    goal_scorers: processedGoals
                };
            });

            this.currentYearData = {
                matches: formattedMatches,
                summaryInfo: summary,
                squad: squadArray, // Áé∞Âú®ËøôÈáåÁöÑ squad ÂåÖÂê´‰∫ÜËÆ°ÁÆóÂ•ΩÁöÑ Apps, Goals, CleanSheets, Conceded
                staff: summary.staff || [],
                photos: summary.photos || [],
                insights: summary.insights || {}
            };
            
            this.matchTypes = Array.from(uniqueTypes);
        },
    
            openMatchModal(match) {
                if (!match) return;
                let detail = JSON.parse(JSON.stringify(match));
                let starters = [];
    
                if (detail.players_on_field && Array.isArray(detail.players_on_field)) {
                    detail.players_on_field.forEach(p => {
                        const rosterInfo = this.currentYearRosterMap && this.currentYearRosterMap[p.player_id] 
                            ? this.currentYearRosterMap[p.player_id] 
                            : { Number: p.number || '-', Position: p.position || 'MF', Name: p.player_name || 'Êú™Áü•ÁêÉÂëò' };
    
                        p.number = rosterInfo.Number !== '-' ? rosterInfo.Number : (p.number || '-');
                        p.Name = rosterInfo.Name; 
                        let pos = rosterInfo.Position;
                        if (!pos || pos === 'Player' || pos === 'Sub' || pos === 'Unknown') { pos = 'MF'; }
                        p.Position = pos;
                        if (p.is_starter) { starters.push(p); }
                    });
                }
    
                const posOrder = { 'GK': 1, 'DF': 2, 'MF': 3, 'FW': 4 };
                starters.sort((a, b) => (posOrder[a.Position] || 3) - (posOrder[b.Position] || 3));
    
                let mfCount = starters.filter(p => p.Position === 'MF').length;
                if (mfCount > 8) {
                    starters.forEach((p, index) => {
                        if (p.Position === 'MF') {
                            if (index < 4) p.Position = 'DF'; 
                            else if (index > 7) p.Position = 'FW';
                        }
                    });
                }
    
                const lines = { 'GK': [], 'DF': [], 'MF': [], 'FW': [] };
                starters.forEach(p => {
                    let key = 'MF';
                    if (p.Position === 'GK') key = 'GK';
                    else if (['CB','LB','RB','DF'].includes(p.Position)) key = 'DF';
                    else if (['ST','CF','LW','RW','FW'].includes(p.Position)) key = 'FW';
                    lines[key].push(p);
                });
    
                starters.forEach(p => {
                    let key = 'MF';
                    if (p.Position === 'GK') key = 'GK';
                    else if (['CB','LB','RB','DF'].includes(p.Position)) key = 'DF';
                    else if (['ST','CF','LW','RW','FW'].includes(p.Position)) key = 'FW';
    
                    const list = lines[key];
                    const index = list.indexOf(p);
                    const count = list.length;
                    const topPositions = { 'GK': 90, 'DF': 75, 'MF': 45, 'FW': 15 };
                    const top = topPositions[key];
                    let spread = 20; 
                    if (count > 3) spread = 18;
                    if (count > 4) spread = 15;
                    const centerOffset = (count - 1) * spread / 2;
                    const left = 50 + (index * spread) - centerOffset;
                    p.visualizeStyle = `left: ${left}%; top: ${top}%;`;
                });
    
                detail.visualizedStarters = starters;
                this.selectedMatch = detail;
            },
    
            // üî• ‰øÆÂ§çÔºöÂ¢ûÂº∫Êï∞ÊçÆÂåπÈÖçÈÄªËæë
            openProfile(id, type, data) { 
            if (!id) return; 
            
            // 1. Â∞ùËØï‰ªéÈòµÂÆπÈáåÊâæÂÆåÊï¥Êï∞ÊçÆ
            let fullData = {};
            if (type === 'player' && this.currentYearData.squad) {
                fullData = this.currentYearData.squad.find(s => String(s.id) === String(id)) || {};
            }

            // 2. ËÆ°ÁÆóÂú∫ÂùáÊï∞ÊçÆ
            let matchesPlayed = fullData.Apps || 0;
            let avgGoals = matchesPlayed > 0 ? (fullData.Goals / matchesPlayed).toFixed(2) : "0.00";
            let avgConceded = matchesPlayed > 0 ? (fullData.Conceded / matchesPlayed).toFixed(2) : "0.00";

            this.selectedProfile = { 
                id, 
                type, 
                Name: this.resolveName(id, fullData.Name || data?.name || data?.player_name), 
                Headshot: 'images/players/default.jpg',
                Position: fullData.Position || data?.position || 'Player', 
                Number: fullData.Number || data?.number || '-', 
                
                // üî• Ê†∏ÂøÉ‰øÆÂ§çÔºöÊääÊâÄÊúâÁªüËÆ°Êï∞ÊçÆÈÉΩÊâìÂåÖÊîæËøõÂéª
                YearStats: { 
                    Apps: matchesPlayed, 
                    Goals: fullData.Goals || 0, 
                    CleanSheets: fullData.CleanSheets || 0,
                    AvgGoals: avgGoals,       // Âú∫ÂùáËøõÁêÉ
                    AvgConceded: avgConceded  // Âú∫Âùá‰∏¢ÁêÉ
                } 
            }; 
        },
    
            getFilteredMatches() { if (!this.currentYearData.matches) return []; if (this.matchFilter === 'all') return this.currentYearData.matches; return this.currentYearData.matches.filter(m => m.Type === this.matchFilter); },
            getPlayersByPos(code) { if (!this.currentYearData.squad) return []; return this.currentYearData.squad.filter(p => { if (code === 'MF') return !['GK', 'DF', 'FW'].includes(p.Position); return p.Position === code; }); },
            performSearch() { if (this.searchQuery.length < 1) { this.searchResults = []; return; } const q = this.searchQuery.toLowerCase(); this.searchResults = Object.entries(this.playerMap).map(([id, name]) => ({ id, name })).filter(p => p.name.includes(q) || p.id.toLowerCase().includes(q)).slice(0, 10); },
            resolveName(id, name, map) { if (name && !String(name).startsWith('P')) return name; if (map && map[id]) return map[id]; return id || '-'; },
            getPositionWeight(pos) { return { 'GK': 1, 'DF': 2, 'MF': 3, 'FW': 4 }[pos] || 99; },
            normalizeResult(res) { if (res === 'W' || res === 'ËÉú') return 'W'; if (res === 'D' || res === 'Âπ≥') return 'D'; return 'L'; }
        }
    }
    </script>
</body>
</html>
